pipeline {
    agent any

    environment {
        GIT_REPO_NAME = "Jenkins-Zero-To-Hero-main"
        GIT_USER_NAME = "JorgeMJNT"
        DOCKER_IMAGE = "jorgejardimneto/ultimate-cicd:${env.BUILD_NUMBER}"
        SONAR_URL = "http://localhost:9000"
        PROJECT_NAME = "spring-boot-demo"
    }

    stages {

        stage('Checkout do Código') {
            steps {
                git 'https://github.com/seu-repositorio.git'
            }
        }

        stage('Compilar e Testar com Maven') {
            steps {
                sh '''
                  echo "Compilando e testando o projeto..."
                  cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                  mvn clean verify package -DskipTests=false
                '''
            }
        }

        stage('Análise de Código com SonarQube') {
            steps {
                withCredentials([string(credentialsId: 'sonar', variable: 'SONAR_AUTH_TOKEN')]) {
                    sh '''
                      cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                      mvn sonar:sonar -Dsonar.login=${SONAR_AUTH_TOKEN} -Dsonar.host.url=$SONAR_URL -Dsonar.projectKey=$PROJECT_NAME
                    '''
                }
            }
        }

        stage('Construção da Imagem Docker') {
            steps {
                script {
                    sh '''
                      echo "Construindo imagem Docker..."
                      cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                      docker build -t ${DOCKER_IMAGE} .
                    '''
                }
            }
        }

        stage('Análise de Segurança com Trivy') {
            steps {
                sh '''
                  echo "Rodando Trivy para análise de vulnerabilidades..."
                  trivy image --severity HIGH,CRITICAL --format json -o trivy-report.json ${DOCKER_IMAGE}
                '''
            }
        }

        stage('Publicar Relatório de Segurança') {
            steps {
                archiveArtifacts artifacts: 'trivy-report.json', fingerprint: true
            }
        }
    }
}
